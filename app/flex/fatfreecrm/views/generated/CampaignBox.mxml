<?xml version="1.0" encoding="utf-8"?>
<mx:HBox xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" label="Campaign"
  xmlns:rx="org.restfulx.components.rx.*">
  <mx:Script><![CDATA[
    import org.restfulx.Rx;
    import org.restfulx.utils.RxUtils;
    import fatfreecrm.models.Campaign;
    import fatfreecrm.models.User;

    [Bindable]
    private var campaign:Campaign = new Campaign();

    private function newCampaign():void {
      campaign = new Campaign();
      campaignsList.selectedIndex = -1;
    }

    private function saveCampaign():void {
      updateModelProperties();
      if (campaign.id) {
        campaign.update({onSuccess: onCampaignUpdate});
      } else {
        campaign.create({onSuccess: onCampaignCreate});
      }
    }
  
    private function updateModelProperties():void {
	  campaign.assignee = User(assignedToComboBox.selectedItem); 
      // campaign.assignedTo = int(assignedToTextInput.text);
      campaign.name = nameTextInput.text;
      campaign.access = accessTextInput.text;
      campaign.status = statusTextInput.text;
      campaign.budget = Number(budgetTextInput.text);
      campaign.targetLeads = int(targetLeadsTextInput.text);
      campaign.targetConversion = Number(targetConversionTextInput.text);
      campaign.targetRevenue = Number(targetRevenueTextInput.text);
      campaign.leadsCount = int(leadsCountTextInput.text);
      campaign.opportunitiesCount = int(opportunitiesCountTextInput.text);
      campaign.revenue = Number(revenueTextInput.text);
      campaign.startsOn = startsOnDateField.selectedDate;
      campaign.endsOn = endsOnDateField.selectedDate;
      campaign.objectives = objectivesTextArea.text;
      campaign.deletedAt = deletedAtDateTimeTextInput.date;
      campaign.backgroundInfo = backgroundInfoTextInput.text;
  
      campaign.user = User(userComboBox.selectedItem);
    }
   
    private function destroyCampaign():void {
      campaign.destroy({onSuccess: onCampaignDestroy});
    }
    
    private function onCampaignSelect():void {
      campaign = RxUtils.clone(campaignsList.selectedItem) as Campaign;
    }
    
    private function onCampaignCreate(result:Campaign):void {
      campaign = new Campaign;
    }
    
    private function onCampaignUpdate(result:Campaign):void {
      campaignsList.selectedItem = result;
      onCampaignSelect();
    }
    
    private function onCampaignDestroy(result:Campaign):void {
      onCampaignCreate(result);
    }    
  ]]></mx:Script>
  <mx:Panel id="campaignsPanel"
    title="Campaigns" cornerRadius="0" backgroundColor="#EEEEEE" width="25%" height="100%">
    <mx:List id="campaignsList"
      width="100%" height="100%"
      dataProvider="{Rx.models.index(Campaign)}"
      change="onCampaignSelect()"/>
    <mx:ControlBar width="100%">
      <mx:Button label="New Campaign" width="100%" height="30"
        click="newCampaign()"/>
    </mx:ControlBar>
  </mx:Panel>
  <mx:Panel title="Edit Campaign" cornerRadius="0" backgroundColor="#EEEEEE" width="75%" height="100%">
    <mx:Form width="100%" height="100%">
      <mx:FormItem label="AssignedTo" width="100%">
		  <mx:ComboBox id="assignedToComboBox" width="200"
					   labelField="{User.LABEL}"
					   dataProvider="{Rx.models.index(User)}" prompt="Assignee ..."
					   selectedItem="{campaign.assignee}"/>

      </mx:FormItem>
      <mx:FormItem label="Name" width="100%">
        <mx:TextInput id="nameTextInput" width="100%" text="{campaign.name}"/>
      </mx:FormItem>
      <mx:FormItem label="Access" width="100%">
        <mx:TextInput id="accessTextInput" width="100%" text="{campaign.access}"/>
      </mx:FormItem>
      <mx:FormItem label="Status" width="100%">
        <mx:TextInput id="statusTextInput" width="100%" text="{campaign.status}"/>
      </mx:FormItem>
      <mx:FormItem label="Budget" width="100%">
        <mx:TextInput id="budgetTextInput" width="100%" text="{campaign.budget}"/>
      </mx:FormItem>
      <mx:FormItem label="TargetLeads" width="100%">
        <mx:TextInput id="targetLeadsTextInput" width="100%" text="{campaign.targetLeads}"/>
      </mx:FormItem>
      <mx:FormItem label="TargetConversion" width="100%">
        <mx:TextInput id="targetConversionTextInput" width="100%" text="{campaign.targetConversion}"/>
      </mx:FormItem>
      <mx:FormItem label="TargetRevenue" width="100%">
        <mx:TextInput id="targetRevenueTextInput" width="100%" text="{campaign.targetRevenue}"/>
      </mx:FormItem>
      <mx:FormItem label="LeadsCount" width="100%">
        <mx:TextInput id="leadsCountTextInput" width="100%" text="{campaign.leadsCount}"/>
      </mx:FormItem>
      <mx:FormItem label="OpportunitiesCount" width="100%">
        <mx:TextInput id="opportunitiesCountTextInput" width="100%" text="{campaign.opportunitiesCount}"/>
      </mx:FormItem>
      <mx:FormItem label="Revenue" width="100%">
        <mx:TextInput id="revenueTextInput" width="100%" text="{campaign.revenue}"/>
      </mx:FormItem>
      <mx:FormItem label="StartsOn" width="100%">
        <mx:DateField id="startsOnDateField" selectedDate="{campaign.startsOn}"/>
      </mx:FormItem>
      <mx:FormItem label="EndsOn" width="100%">
        <mx:DateField id="endsOnDateField" selectedDate="{campaign.endsOn}"/>
      </mx:FormItem>
      <mx:FormItem label="Objectives" width="100%">
        <mx:TextArea id="objectivesTextArea" width="100%" height="200" text="{campaign.objectives}"/>
      </mx:FormItem>
      <mx:FormItem label="DeletedAt" width="100%">
        <rx:DateTimeTextInput id="deletedAtDateTimeTextInput" width="200" date="{campaign.deletedAt}"/>
      </mx:FormItem>
      <mx:FormItem label="BackgroundInfo" width="100%">
        <mx:TextInput id="backgroundInfoTextInput" width="100%" text="{campaign.backgroundInfo}"/>
      </mx:FormItem>
      <mx:FormItem label="User" width="100%">
        <mx:ComboBox id="userComboBox" width="200"
          labelField="{User.LABEL}"
          dataProvider="{Rx.models.index(User)}" prompt="User ..."
          selectedItem="{campaign.user}"/>
      </mx:FormItem>
    </mx:Form>
    <mx:ControlBar width="100%">
      <mx:Button label="Save Campaign" width="50%" height="30"
        click="saveCampaign()"/>
      <mx:Button label="Delete Campaign" width="50%" height="30"
        enabled="{RxUtils.canDeleteModel(campaign)}"
        click="destroyCampaign()"/>
    </mx:ControlBar>
  </mx:Panel>
</mx:HBox>